<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VK INFRASTRUCTURE</title>
  <style>
    body { font-family: Arial, sans-serif; background:#eef2f5; margin:0; padding:0; }
    .page { display:none; padding:20px; }
    .page.active { display:block; }
    .container { max-width:1000px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    h2,h3 { text-align:center; }
    input,select,textarea,button { width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:8px; }
    button { background:#2a3248; color:white; cursor:pointer; font-weight:bold; }
    button:hover { background:#3d4663; }
    table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; }
    th,td { border:1px solid #333; padding:6px; text-align:center; }
    th { background:#2a3248; color:white; }
    .actions button { width:auto; margin:2px; padding:4px 8px; font-size:12px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<!-- ğŸ” Login Page -->
<div id="loginPage" class="page active">
  <div class="container">
    <h2>VK INFRASTRUCTURE</h2>
    <input type="text" id="loginId" placeholder="Enter ID">
    <input type="password" id="loginPass" placeholder="Enter Password">
    <button onclick="login()">ğŸ” LOGIN</button>
  </div>
</div>

<!-- ğŸ“Š Dashboard -->
<div id="dashboard" class="page">
  <div class="container dashboard">
    <h3>Dashboard</h3>
    <button onclick="openPage('dataEntry')" id="dataEntryBtn">ğŸ“ Data Entry</button>
    <button onclick="loadReports()">ğŸ“‘ Reports</button>
    <button onclick="openPage('overallReport')">ğŸ“‹ Overall Report</button>
    <button id="adminPassBtn" onclick="openPage('changeAdminPassword')">ğŸ”’ Change Admin Password</button>
    <button id="viewerPassBtn" onclick="openPage('changeViewerPassword')">ğŸ”’ Change Viewer Password</button>
    <button onclick="logout()">ğŸšª Logout</button>
  </div>
</div>

<!-- ğŸ“ Data Entry -->
<div id="dataEntry" class="page">
  <div class="container">
    <h3>Data Entry</h3>
    <input type="hidden" id="editIndex" value="">
    <input type="date" id="date">
    <input type="text" id="vehicleType" placeholder="Vehicle Type">
    <input type="text" id="vehicleNumber" placeholder="Vehicle Number">
    <input type="text" id="driver" placeholder="Driver Name">
    <label>Morning Start</label><input type="time" id="morningStart">
    <label>Morning End</label><input type="time" id="morningEnd">
    <label>Afternoon Start</label><input type="time" id="afternoonStart">
    <label>Afternoon End</label><input type="time" id="afternoonEnd">
    <input type="number" id="diesel" placeholder="Diesel Liters">
    <select id="engage">
      <option value="Full Day">Full Day</option>
      <option value="Half Day">Half Day</option>
    </select>
    <textarea id="description" placeholder="Description"></textarea>
    <button onclick="saveData()">ğŸ’¾ Save</button>
    <button onclick="backToDashboard()">ğŸ”™ Back</button>
  </div>
</div>

<!-- ğŸ“‘ Reports -->
<div id="reports" class="page">
  <div class="container">
    <h3>Reports</h3>
    <input type="date" id="reportDate">
    <button onclick="loadReports()">ğŸ” Search</button>
    <table id="reportTable">
      <thead>
        <tr>
          <th>Date</th><th>Vehicle Type</th><th>Vehicle No</th><th>Driver</th>
          <th>Morning</th><th>Afternoon</th><th>Diesel</th><th>Engage</th><th>Description</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="exportPDF()">ğŸ“„ PDF</button>
    <button onclick="window.print()">ğŸ–¨ï¸ Print</button>
    <button onclick="backToDashboard()">ğŸ”™ Back</button>
  </div>
</div>

<!-- ğŸ“‹ Overall Report -->
<div id="overallReport" class="page">
  <div class="container">
    <h3>Overall Report</h3>
    <label>From</label><input type="date" id="fromDate">
    <label>To</label><input type="date" id="toDate">
    <button onclick="loadOverall()">ğŸ” Generate</button>
    <table id="overallTable">
      <thead>
        <tr>
          <th>Driver</th><th>Vehicle Type</th><th>Vehicle No</th>
          <th>Total Hours</th><th>Total Days</th><th>Total Diesel</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="exportOverallPDF()">ğŸ“„ PDF</button>
    <button onclick="window.print()">ğŸ–¨ï¸ Print</button>
    <button onclick="backToDashboard()">ğŸ”™ Back</button>
  </div>
</div>

<!-- ğŸ”‘ Change Password Pages -->
<div id="changeAdminPassword" class="page">
  <div class="container">
    <h3>Change Admin Password</h3>
    <input type="password" id="oldAdminPass" placeholder="Old Admin Password">
    <input type="password" id="newAdminPass" placeholder="New Admin Password">
    <button onclick="changeAdminPassword()">Save Password</button>
    <button onclick="backToDashboard()">ğŸ”™ Back</button>
  </div>
</div>

<div id="changeViewerPassword" class="page">
  <div class="container">
    <h3>Change Viewer Password</h3>
    <input type="password" id="oldViewerPass" placeholder="Old Viewer Password">
    <input type="password" id="newViewerPass" placeholder="New Viewer Password">
    <button onclick="changeViewerPassword()">Save Password</button>
    <button onclick="backToDashboard()">ğŸ”™ Back</button>
  </div>
</div>

<!-- âœ… Firebase Integration -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, deleteDoc, doc } 
    from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDEoXnmRndIWlXgEExOsqscSGqhgy8IqVI",
    authDomain: "vk-infra.firebaseapp.com",
    projectId: "vk-infra",
    storageBucket: "vk-infra.firebasestorage.app",
    messagingSenderId: "8449193426",
    appId: "1:8449193426:web:bbd5d1139e045fbcf7c40b",
    measurementId: "G-QHNWWT8CZP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let userRole="";
  if(!localStorage.getItem("adminPass")) localStorage.setItem("adminPass","Rajesh@1234");
  if(!localStorage.getItem("viewerPass")) localStorage.setItem("viewerPass","Viewer");

  // ---- PAGE CONTROL ----
  window.showPage=function(id){ 
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
    document.getElementById(id).classList.add('active'); 
  }

  window.openPage=function(id){ 
    showPage(id); 
    if(id==="dataEntry"){  
      if(!document.getElementById("editIndex").value){  
        document.querySelectorAll("#dataEntry input, #dataEntry textarea, #dataEntry select")
          .forEach(el=>{
            if(el.type!=="button" && el.type!=="hidden") el.value="";
          });
      }
    }
  }

  window.backToDashboard=function(){ showPage("dashboard"); }
  window.logout=function(){ userRole=""; showPage("loginPage"); }

  // ---- LOGIN ----
  window.login=function(){
    let id=document.getElementById("loginId").value.trim();
    let pass=document.getElementById("loginPass").value.trim();
    let adminPass=localStorage.getItem("adminPass");
    let viewerPass=localStorage.getItem("viewerPass");

    if(id==="VK INFRA" && pass===adminPass){
      userRole="admin"; showPage("dashboard"); setupDashboard();
    }
    else if(id==="VK INFRA" && pass===viewerPass){
      userRole="viewer"; showPage("dashboard"); setupDashboard();
    }
    else { alert("âŒ Invalid ID or Password"); }
  }

  function setupDashboard(){
    document.getElementById("dataEntryBtn").style.display = userRole==="admin"?"block":"none";
    document.getElementById("adminPassBtn").style.display = userRole==="admin"?"block":"none";
    document.getElementById("viewerPassBtn").style.display = userRole==="admin"?"block":"none";
  }

  // ---- SAVE DATA ----
  window.saveData = async function(){
    let idx=document.getElementById("editIndex").value;
    let data={
      date:date.value, vehicleType:vehicleType.value, vehicleNumber:vehicleNumber.value,
      driver:driver.value, morningStart:morningStart.value, morningEnd:morningEnd.value,
      afternoonStart:afternoonStart.value, afternoonEnd:afternoonEnd.value,
      diesel:diesel.value, engage:engage.value, description:description.value
    };

    if(idx){ 
      await updateDoc(doc(db,"logs",idx),data);
      alert("âœï¸ Entry Updated!");
      document.getElementById("editIndex").value="";
    } else {
      await addDoc(collection(db,"logs"),data);
      alert("âœ… Data Saved!");
    }
    backToDashboard();
  }

  // ---- LOAD REPORTS ----
  window.loadReports = async function(){
    showPage("reports");
    let dateVal=document.getElementById("reportDate").value;
    let tbody=document.querySelector("#reportTable tbody"); tbody.innerHTML="";
    
    let q = dateVal ? query(collection(db,"logs"), where("date","==",dateVal)) : collection(db,"logs");
    let snap=await getDocs(q);

    snap.forEach((docSnap)=>{
      let d=docSnap.data();
      let id=docSnap.id;
      let actions="";
      if(userRole==="admin"){
        actions+=`<button onclick="editEntry('${id}')">âœï¸</button>`;
        actions+=`<button onclick="deleteEntry('${id}')">ğŸ—‘ï¸</button>`;
      }
      tbody.innerHTML+=`<tr>
        <td>${d.date}</td><td>${d.vehicleType}</td><td>${d.vehicleNumber}</td><td>${d.driver}</td>
        <td>${d.morningStart}-${d.morningEnd}</td><td>${d.afternoonStart}-${d.afternoonEnd}</td>
        <td>${d.diesel}</td><td>${d.engage}</td><td>${d.description}</td><td>${actions}</td>
      </tr>`;
    });
  }

  // ---- EDIT ----
  window.editEntry = async function(id){
    let snap=await getDocs(query(collection(db,"logs"),where("__name__","==",id)));
    let d=snap.docs[0].data();
    document.getElementById("editIndex").value=id;
    date.value=d.date; vehicleType.value=d.vehicleType; vehicleNumber.value=d.vehicleNumber;
    driver.value=d.driver; morningStart.value=d.morningStart; morningEnd.value=d.morningEnd;
    afternoonStart.value=d.afternoonStart; afternoonEnd.value=d.afternoonEnd;
    diesel.value=d.diesel; engage.value=d.engage; description.value=d.description;
    showPage("dataEntry");
  }

  // ---- DELETE ----
  window.deleteEntry = async function(id){
    await deleteDoc(doc(db,"logs",id));
    alert("ğŸ—‘ï¸ Deleted!");
    loadReports();
  }

  // ---- PDF EXPORT ----
  window.exportPDF=function(){
    let { jsPDF } = window.jspdf;
    let doc = new jsPDF();
    doc.text("VK INFRASTRUCTURE - Reports", 14, 15);
    doc.autoTable({ html: '#reportTable', startY: 20, theme: 'grid', styles: { fontSize: 8 } });
    doc.save("Reports.pdf");
  }

  window.exportOverallPDF=function(){
    let { jsPDF } = window.jspdf;
    let doc = new jsPDF();
    doc.text("VK INFRASTRUCTURE - Overall Report", 14, 15);
    doc.autoTable({ html: '#overallTable', startY: 20, theme: 'grid', styles: { fontSize: 8 } });
    doc.save("Overall_Report.pdf");
  }

  // ---- TIME CALC ----
  function calcMinutes(start,end){
    if(!start||!end) return 0;
    let s=start.split(":"), e=end.split(":");
    return (parseInt(e[0])*60+parseInt(e[1]))-(parseInt(s[0])*60+parseInt(s[1]));
  }

  // ---- OVERALL REPORT ----
  window.loadOverall = async function(){
    let from=new Date(document.getElementById("fromDate").value);
    let to=new Date(document.getElementById("toDate").value);
    let tbody=document.querySelector("#overallTable tbody"); 
    tbody.innerHTML="";
    
    let snap=await getDocs(collection(db,"logs"));
    let summary={};
    snap.forEach(docSnap=>{
      let d=docSnap.data();
      let dt=new Date(d.date);
      if((!isNaN(from)&&dt<from)||(!isNaN(to)&&dt>to)) return;
      let key=d.driver+"_"+d.vehicleNumber;
      if(!summary[key]) summary[key]={driver:d.driver, type:d.vehicleType, num:d.vehicleNumber, mins:0, days:0, diesel:0};
      summary[key].days++;
      summary[key].diesel+=Number(d.diesel||0);
      summary[key].mins+=calcMinutes(d.morningStart,d.morningEnd)+calcMinutes(d.afternoonStart,d.afternoonEnd);
    });

    Object.values(summary).forEach(s=>{
      let h=Math.floor(s.mins/60);
      let m=s.mins%60;
      tbody.innerHTML+=`<tr>
        <td>${s.driver}</td><td>${s.type}</td><td>${s.num}</td>
        <td>${h}h ${m}m</td><td>${s.days}</td><td>${s.diesel}</td>
      </tr>`;
    });
  }

  // ---- PASSWORD CHANGE ----
  window.changeAdminPassword=function(){
    let oldp=document.getElementById("oldAdminPass").value;
    let newp=document.getElementById("newAdminPass").value;
    if(oldp===localStorage.getItem("adminPass")){
      if(newp){ localStorage.setItem("adminPass",newp); alert("âœ… Admin password changed!"); backToDashboard(); }
      else alert("Enter new password");
    } else alert("âŒ Old password incorrect");
  }

  window.changeViewerPassword=function(){
    let oldp=document.getElementById("oldViewerPass").value;
    let newp=document.getElementById("newViewerPass").value;
    if(oldp===localStorage.getItem("viewerPass")){
      if(newp){ localStorage.setItem("viewerPass",newp); alert("âœ… Viewer password changed!"); backToDashboard(); }
      else alert("Enter new password");
    } else alert("âŒ Old password incorrect");
  }

</script>
</body>
</html>