<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VK INFRASTRUCTURE</title>
  <style>
    body { font-family: Arial, sans-serif; background:#eef2f5; margin:0; }
    header { background:#2a3248; color:#fff; text-align:center; padding:12px; font-size:20px; font-weight:bold; }
    .page { display:none; padding:20px; }
    .page.active { display:block; }
    .container { max-width:1000px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    h2,h3 { text-align:center; margin:10px 0; }
    input,select,textarea,button { width:100%; padding:8px; margin:6px 0; border:1px solid #ccc; border-radius:8px; }
    button { background:#2a3248; color:#fff; cursor:pointer; font-weight:bold; }
    button:hover { background:#3d4663; }
    table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; }
    th,td { border:1px solid #444; padding:6px; text-align:center; }
    th { background:#2a3248; color:white; }
    .actions button { width:auto; margin:2px; padding:4px 8px; font-size:12px; }
    .flex { display:flex; gap:20px; }
    .box { flex:1; padding:10px; border:1px solid #ccc; border-radius:8px; background:#fafafa; }
  </style>
</head>
<body>

<header>VK INFRASTRUCTURE</header>

<!-- ğŸ” Login Page -->
<div id="loginPage" class="page active">
  <div class="container">
    <h2>Login</h2>
    <input type="text" id="loginId" placeholder="Enter ID">
    <input type="password" id="loginPass" placeholder="Enter Password">
    <button onclick="login()">ğŸ” LOGIN</button>
  </div>
</div>

<!-- ğŸ“Š Dashboard -->
<div id="dashboard" class="page">
  <div class="container">
    <h3>Dashboard</h3>
    <button onclick="openPage('dataEntry')" id="dataEntryBtn">ğŸ“ Data Entry</button>
    <button onclick="loadReports()">ğŸ“‘ Reports</button>
    <button onclick="openPage('overallReport')">ğŸ“‹ Overall Report</button>
    <button onclick="openPage('fuelEntry')" id="fuelEntryBtn">â›½ Fuel Entry</button>
    <button onclick="loadFuelReport()">â›½ Fuel Report</button>
    <button onclick="openPage('changePassword')" id="passBtn">ğŸ”’ Change Passwords</button>
    <button onclick="logout()">ğŸšª Logout</button>
  </div>
</div>

<!-- ğŸ“ Data Entry -->
<div id="dataEntry" class="page">
  <div class="container">
    <h3>Data Entry</h3>
    <input type="hidden" id="editIndex">
    <input type="date" id="date">
    <input type="text" id="vehicleType" placeholder="Vehicle Type">
    <input type="text" id="vehicleNumber" placeholder="Vehicle Number">
    <input type="text" id="driver" placeholder="Driver Name">
    <label>Morning Start</label><input type="time" id="morningStart">
    <label>Morning End</label><input type="time" id="morningEnd">
    <label>Afternoon Start</label><input type="time" id="afternoonStart">
    <label>Afternoon End</label><input type="time" id="afternoonEnd">
    <input type="number" id="diesel" placeholder="Diesel Liters">
    <select id="engage"><option>Full Day</option><option>Half Day</option></select>
    <textarea id="description" placeholder="Description"></textarea>
    <button onclick="saveData()">ğŸ’¾ Save</button>
    <button onclick="backToDashboard()">ğŸ”™ Back</button>
  </div>
</div>

<!-- ğŸ“‘ Reports -->
<div id="reports" class="page">
  <div class="container">
    <h3>Reports</h3>
    <input type="date" id="reportDate">
    <button onclick="loadReports()">ğŸ” Search</button>
    <table id="reportTable"><thead>
      <tr><th>Date</th><th>Vehicle Type</th><th>Number</th><th>Driver</th>
      <th>Morning</th><th>Afternoon</th><th>Diesel</th><th>Engage</th><th>Desc</th><th>Actions</th></tr>
    </thead><tbody></tbody></table>
    <button onclick="window.print()">ğŸ–¨ï¸ Print</button>
    <button onclick="backToDashboard()">ğŸ”™ Back</button>
  </div>
</div>

<!-- ğŸ“‹ Overall Report -->
<div id="overallReport" class="page">
  <div class="container">
    <h3>Overall Report</h3>
    <label>From</label><input type="date" id="fromDate">
    <label>To</label><input type="date" id="toDate">
    <button onclick="loadOverall()">ğŸ” Generate</button>
    <table id="overallTable"><thead>
      <tr><th>Driver</th><th>Vehicle Type</th><th>No</th><th>Total Hrs</th><th>Full Days</th><th>Half Days</th><th>Diesel</th></tr>
    </thead><tbody></tbody></table>
    <button onclick="window.print()">ğŸ–¨ï¸ Print</button>
    <button onclick="backToDashboard()">ğŸ”™ Back</button>
  </div>
</div>

<!-- â›½ Fuel Entry -->
<div id="fuelEntry" class="page">
  <div class="container">
    <h3>Fuel Entry</h3>
    <input type="hidden" id="fuelEditId">
    <input type="date" id="fuelDate">
    <input type="number" id="fuelLiters" placeholder="Fuel Liters">
    <button onclick="saveFuel()">ğŸ’¾ Save</button>
    <button onclick="backToDashboard()">ğŸ”™ Back</button>
  </div>
</div>

<!-- â›½ Fuel Report -->
<div id="fuelReport" class="page">
  <div class="container">
    <h3>Fuel Report</h3>
    <div class="flex">
      <div class="box">
        <h4>Present Fuel Report</h4>
        <p>Fuel Limit: <span id="fuelLimit">0</span></p>
        <p>Old Stock: <span id="oldStock">0</span></p>
        <p>Used Fuel: <span id="usedFuel">0</span></p>
        <p>Remaining Fuel: <span id="remainingFuel">0</span></p>
      </div>
      <div class="box">
        <h4>Overall Fuel Report</h4>
        <p>Overall Fuel: <span id="overallFuel">0</span></p>
        <p>Used Overall: <span id="usedOverall">0</span></p>
        <p>Remaining Overall: <span id="remainingOverall">0</span></p>
      </div>
    </div>
    <table id="fuelTable"><thead><tr><th>Date</th><th>Liters</th><th>Actions</th></tr></thead><tbody></tbody></table>
    <button onclick="window.print()">ğŸ–¨ï¸ Print</button>
    <button onclick="backToDashboard()">ğŸ”™ Back</button>
  </div>
</div>

<!-- ğŸ”‘ Change Password -->
<div id="changePassword" class="page">
  <div class="container">
    <h3>Change Passwords</h3>
    <h4>Admin Password</h4>
    <input type="password" id="oldAdminPass" placeholder="Old Admin Password">
    <input type="password" id="newAdminPass" placeholder="New Admin Password">
    <button onclick="changeAdminPassword()">Save Admin Password</button>
    <h4>Viewer Password</h4>
    <input type="password" id="oldViewerPass" placeholder="Old Viewer Password">
    <input type="password" id="newViewerPass" placeholder="New Viewer Password">
    <button onclick="changeViewerPassword()">Save Viewer Password</button>
    <button onclick="backToDashboard()">ğŸ”™ Back</button>
  </div>
</div>

<!-- âœ… Firebase + JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, deleteDoc, doc } 
  from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDEoXnmRndIWlXgEExOsqscSGqhgy8IqVI",
  authDomain: "vk-infra.firebaseapp.com",
  projectId: "vk-infra",
  storageBucket: "vk-infra.firebasestorage.app",
  messagingSenderId: "8449193426",
  appId: "1:8449193426:web:bbd5d1139e045fbcf7c40b"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---- LOGIN ----
let userRole="";
if(!localStorage.getItem("adminPass")) localStorage.setItem("adminPass","Noteultra");
if(!localStorage.getItem("viewerPass")) localStorage.setItem("viewerPass","Viewer");

function showPage(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
window.openPage=id=>showPage(id);
window.backToDashboard=()=>showPage("dashboard");
window.logout=()=>{ userRole=""; showPage("loginPage"); }

window.login=function(){
  let id=document.getElementById("loginId").value.trim();
  let pass=document.getElementById("loginPass").value.trim();
  let ap=localStorage.getItem("adminPass"), vp=localStorage.getItem("viewerPass");
  if(id==="VK INFRA" && pass===ap){ userRole="admin"; setupDashboard(); showPage("dashboard"); }
  else if(id==="VK INFRA" && pass===vp){ userRole="viewer"; setupDashboard(); showPage("dashboard"); }
  else alert("âŒ Invalid ID or Password");
}
function setupDashboard(){
  document.getElementById("dataEntryBtn").style.display=(userRole==="admin")?"block":"none";
  document.getElementById("fuelEntryBtn").style.display=(userRole==="admin")?"block":"none";
  document.getElementById("passBtn").style.display=(userRole==="admin")?"block":"none";
}

// ---- SAVE DATA ----
window.saveData=async function(){
  let data={date:date.value, vehicleType:vehicleType.value, vehicleNumber:vehicleNumber.value, driver:driver.value,
    morningStart:morningStart.value, morningEnd:morningEnd.value, afternoonStart:afternoonStart.value, afternoonEnd:afternoonEnd.value,
    diesel:diesel.value, engage:engage.value, description:description.value};
  if(editIndex.value){ await updateDoc(doc(db,"logs",editIndex.value),data); alert("âœ… Updated!"); }
  else{ await addDoc(collection(db,"logs"),data); alert("âœ… Saved!"); }
  editIndex.value=""; backToDashboard();
}

// ---- LOAD REPORTS ----
window.loadReports=async function(){
  showPage("reports");
  let dateVal=reportDate.value;
  let tbody=document.querySelector("#reportTable tbody"); tbody.innerHTML="";
  let q=dateVal?query(collection(db,"logs"),where("date","==",dateVal)):collection(db,"logs");
  let snap=await getDocs(q);
  snap.forEach(docSnap=>{
    let d=docSnap.data(), id=docSnap.id;
    let actions="";
    if(userRole==="admin"){ actions+=`<button onclick="editEntry('${id}')">âœï¸</button><button onclick="deleteEntry('${id}')">ğŸ—‘ï¸</button>`; }
    tbody.innerHTML+=`<tr><td>${d.date}</td><td>${d.vehicleType}</td><td>${d.vehicleNumber}</td>
    <td>${d.driver}</td><td>${d.morningStart}-${d.morningEnd}</td><td>${d.afternoonStart}-${d.afternoonEnd}</td>
    <td>${d.diesel}</td><td>${d.engage}</td><td>${d.description}</td><td>${actions}</td></tr>`;
  });
}

// ---- EDIT ----
window.editEntry=async function(id){
  let snap=await getDocs(query(collection(db,"logs"),where("__name__","==",id)));
  let d=snap.docs[0].data(); editIndex.value=id;
  date.value=d.date; vehicleType.value=d.vehicleType; vehicleNumber.value=d.vehicleNumber;
  driver.value=d.driver; morningStart.value=d.morningStart; morningEnd.value=d.morningEnd;
  afternoonStart.value=d.afternoonStart; afternoonEnd.value=d.afternoonEnd;
  diesel.value=d.diesel; engage.value=d.engage; description.value=d.description;
  showPage("dataEntry");
}
window.deleteEntry=async id=>{ await deleteDoc(doc(db,"logs",id)); alert("ğŸ—‘ï¸ Deleted"); loadReports(); }

// ---- OVERALL REPORT ----
function calcMinutes(s,e){ if(!s||!e) return 0; let [sh,sm]=s.split(":"), [eh,em]=e.split(":"); return (eh*60+ +em)-(sh*60+ +sm); }
window.loadOverall=async function(){
  let from=new Date(fromDate.value), to=new Date(toDate.value);
  let tbody=document.querySelector("#overallTable tbody"); tbody.innerHTML="";
  let snap=await getDocs(collection(db,"logs")); let summary={};
  snap.forEach(docSnap=>{
    let d=docSnap.data(); let dt=new Date(d.date); if((!isNaN(from)&&dt<from)||(!isNaN(to)&&dt>to)) return;
    let k=d.driver+"_"+d.vehicleNumber;
    if(!summary[k]) summary[k]={driver:d.driver,type:d.vehicleType,num:d.vehicleNumber,mins:0,full:0,half:0,diesel:0};
    if(d.engage==="Full Day") summary[k].full++; if(d.engage==="Half Day") summary[k].half++;
    summary[k].diesel+=+d.diesel||0;
    summary[k].mins+=calcMinutes(d.morningStart,d.morningEnd)+calcMinutes(d.afternoonStart,d.afternoonEnd);
  });
  Object.values(summary).forEach(s=>{
    let h=Math.floor(s.mins/60), m=s.mins%60;
    tbody.innerHTML+=`<tr><td>${s.driver}</td><td>${s.type}</td><td>${s.num}</td>
    <td>${h}h ${m}m</td><td>${s.full}</td><td>${s.half}</td><td>${s.diesel}</td></tr>`;
  });
}

// ---- FUEL ----
window.saveFuel=async function(){
  let d={date:fuelDate.value, liters:fuelLiters.value};
  if(fuelEditId.value){ await updateDoc(doc(db,"fuel",fuelEditId.value),d); alert("âœ… Fuel Updated!"); }
  else{ await addDoc(collection(db,"fuel"),d); alert("âœ… Fuel Saved!"); }
  fuelEditId.value=""; fuelDate.value=""; fuelLiters.value=""; backToDashboard();
}
window.loadFuelReport=async function(){
  showPage("fuelReport");
  let tbody=document.querySelector("#fuelTable tbody"); tbody.innerHTML="";
  let snap=await getDocs(collection(db,"fuel")); 
  let fuelEntries=[];
  snap.forEach(docSnap=>{ fuelEntries.push({id:docSnap.id,...docSnap.data()}); });

  // sort by date
  fuelEntries.sort((a,b)=>new Date(a.date)-new Date(b.date));

  fuelEntries.forEach(f=>{
    tbody.innerHTML+=`<tr><td>${f.date}</td><td>${f.liters}</td>
    <td><button onclick="editFuel('${f.id}')">âœï¸</button><button onclick="deleteFuel('${f.id}')">ğŸ—‘ï¸</button></td></tr>`;
  });

  let total=fuelEntries.reduce((s,f)=>s+Number(f.liters||0),0);
  let last=fuelEntries.length?Number(fuelEntries[fuelEntries.length-1].liters):0;
  let oldStock=total-last;

  let used=0; let logSnap=await getDocs(collection(db,"logs")); logSnap.forEach(ds=>used+=+ds.data().diesel||0);

  document.getElementById("fuelLimit").innerText=last;
  document.getElementById("oldStock").innerText=oldStock;
  document.getElementById("usedFuel").innerText=used;
  document.getElementById("remainingFuel").innerText=total-used;

  document.getElementById("overallFuel").innerText=total;
  document.getElementById("usedOverall").innerText=used;
  document.getElementById("remainingOverall").innerText=total-used;
}
window.editFuel=async function(id){ let snap=await getDocs(query(collection(db,"fuel"),where("__name__","==",id))); let d=snap.docs[0].data();
  fuelEditId.value=id; fuelDate.value=d.date; fuelLiters.value=d.liters; showPage("fuelEntry");
}
window.deleteFuel=async id=>{ await deleteDoc(doc(db,"fuel",id)); alert("ğŸ—‘ï¸ Fuel Deleted"); loadFuelReport(); }

// --- Password Change ---
  window.changeAdminPassword=function(){ if(oldAdminPass.value===localStorage.getItem("adminPass")&&newAdminPass.value){ localStorage.setItem("adminPass",newAdminPass.value); alert("Admin password changed!"); backToDashboard(); } else alert("Wrong Admin Password"); }
  window.changeViewerPassword=function(){ if(oldViewerPass.value===localStorage.getItem("viewerPass")&&newViewerPass.value){ localStorage.setItem("viewerPass",newViewerPass.value); alert("Viewer password changed!"); backToDashboard(); } else alert("Wrong Viewer Password"); }

  // fuel report load
  document.querySelector("button[onclick=\"openPage('fuelReport')\"]").setAttribute("onclick","loadFuelReport()");
</script>
</body>
</html>