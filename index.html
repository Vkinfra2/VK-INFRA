<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VK INFRASTRUCTURE</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; margin:0; padding:0; }
    header { background:#2c3e50; color:#fff; padding:15px; text-align:center; font-size:22px; }
    .page { display:none; padding:20px; }
    .active { display:block; }
    .container { max-width:95%; margin:20px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    input, select, textarea, button { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
    button { background:#2c3e50; color:#fff; font-weight:bold; cursor:pointer; }
    button:hover { background:#1a252f; }
    .dashboard button { margin:10px 0; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th, td { border:1px solid #aaa; padding:8px; text-align:left; font-size:14px; }
    th { background:#2c3e50; color:white; }
    .actions button { width:auto; margin:2px; padding:5px 8px; font-size:12px; }
  </style>
</head>
<body>
  <header>VK INFRASTRUCTURE</header>

  <!-- 🔑 Login Page -->
  <div id="loginPage" class="page active">
    <div class="container">
      <h3>🔐 LOGIN</h3>
      <input type="text" id="loginId" placeholder="Enter ID">
      <input type="password" id="loginPass" placeholder="Enter Password">
      <button onclick="login()">Login</button>
    </div>
  </div>

  <!-- 📊 Dashboard -->
  <div id="dashboard" class="page">
    <div class="container dashboard">
      <h3>Dashboard</h3>
      <button onclick="openPage('dataEntry')">📝 Data Entry</button>
      <button onclick="loadReports()">📑 Reports</button>
      <button onclick="openPage('overallReport')">📋 Overall Report</button>
      <button onclick="openPage('changePassword')">🔒 Change Password</button>
      <button onclick="logout()">🚪 Logout</button>
    </div>
  </div>

  <!-- 📝 Data Entry -->
  <div id="dataEntry" class="page">
    <div class="container">
      <h3>Data Entry</h3>
      <label>Date</label><input type="date" id="date">
      <label>Vehicle Type</label><input type="text" id="vehicleType">
      <label>Vehicle Number</label><input type="text" id="vehicleNumber">
      <label>Driver Name</label><input type="text" id="driver">
      <label>Morning Start</label><input type="time" id="mStart">
      <label>Morning End</label><input type="time" id="mEnd">
      <label>Afternoon Start</label><input type="time" id="aStart">
      <label>Afternoon End</label><input type="time" id="aEnd">
      <label>Diesel (L)</label><input type="number" id="diesel">
      <label>Engage</label>
      <select id="engage"><option>Full Day</option><option>Half Day</option></select>
      <label>Description</label><textarea id="desc"></textarea>
      <button id="saveBtn">💾 Save</button>
      <button onclick="backToDashboard()">🔙 Back</button>
    </div>
  </div>

  <!-- 📑 Reports -->
  <div id="reports" class="page">
    <div class="container">
      <h3>Reports</h3>
      <table id="reportTable">
        <thead>
          <tr>
            <th>Date</th><th>Vehicle</th><th>No</th><th>Driver</th>
            <th>Morning</th><th>Afternoon</th><th>Diesel</th>
            <th>Engage</th><th>Description</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <br>
      <button onclick="exportCSV()">⬇️ CSV</button>
      <button onclick="printReport()">🖨️ Print</button>
      <button onclick="exportPDF()">📄 PDF</button>
      <button onclick="backToDashboard()">🔙 Back</button>
    </div>
  </div>

  <!-- 📋 Overall Report -->
  <div id="overallReport" class="page">
    <div class="container">
      <h3>Overall Report</h3>
      <label>From</label><input type="date" id="fromDate">
      <label>To</label><input type="date" id="toDate">
      <button onclick="generateOverallReport()">Generate</button>
      <table id="overallTable">
        <thead>
          <tr>
            <th>Driver</th><th>Vehicle</th><th>No</th>
            <th>Total Days</th><th>Total Hours</th><th>Total Diesel</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="backToDashboard()">🔙 Back</button>
    </div>
  </div>

  <!-- 🔒 Change Password -->
  <div id="changePassword" class="page">
    <div class="container">
      <h3>Change Password</h3>
      <input type="password" id="oldPass" placeholder="Old Password">
      <input type="password" id="newPass" placeholder="New Password">
      <button onclick="changePassword()">Save Password</button>
      <button onclick="backToDashboard()">🔙 Back</button>
    </div>
  </div>

  <!-- 🔥 Firebase + JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEoXnmRndIWlXgEExOsqscSGqhgy8IqVI",
      authDomain: "vk-infra.firebaseapp.com",
      projectId: "vk-infra",
      storageBucket: "vk-infra.firebasestorage.app",
      messagingSenderId: "8449193426",
      appId: "1:8449193426:web:bbd5d1139e045fbcf7c40b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Save Entry
    document.getElementById("saveBtn").addEventListener("click", async () => {
      let entry = {
        date: document.getElementById("date").value,
        vehicleType: document.getElementById("vehicleType").value,
        vehicleNumber: document.getElementById("vehicleNumber").value,
        driver: document.getElementById("driver").value,
        morningStart: document.getElementById("mStart").value,
        morningEnd: document.getElementById("mEnd").value,
        afternoonStart: document.getElementById("aStart").value,
        afternoonEnd: document.getElementById("aEnd").value,
        diesel: parseFloat(document.getElementById("diesel").value) || 0,
        engage: document.getElementById("engage").value,
        description: document.getElementById("desc").value
      };
      await addDoc(collection(db, "logs"), entry);
      alert("✅ Saved!");
      backToDashboard();
    });

    // Load Reports
    window.loadReports = async function() {
      let tbody = document.querySelector("#reportTable tbody");
      tbody.innerHTML = "";
      const snapshot = await getDocs(collection(db, "logs"));
      snapshot.forEach(snap => {
        let d = snap.data();
        tbody.innerHTML += `<tr>
          <td>${d.date}</td>
          <td>${d.vehicleType}</td>
          <td>${d.vehicleNumber}</td>
          <td>${d.driver}</td>
          <td>${d.morningStart} - ${d.morningEnd}</td>
          <td>${d.afternoonStart} - ${d.afternoonEnd}</td>
          <td>${d.diesel}</td>
          <td>${d.engage}</td>
          <td>${d.description}</td>
          <td class="actions">
            <button onclick="editEntry('${snap.id}','${d.driver}')">✏️</button>
            <button onclick="deleteEntry('${snap.id}')">🗑️</button>
            <button onclick="shareWhatsApp('${d.driver}','${d.vehicleNumber}','${d.date}')">📲</button>
          </td>
        </tr>`;
      });
      showPage("reports");
    }

    // Delete Entry
    window.deleteEntry = async function(id) {
      if(confirm("Delete this entry?")) {
        await deleteDoc(doc(db, "logs", id));
        loadReports();
      }
    }

    // Edit Entry (Driver only for demo)
    window.editEntry = async function(id, oldDriver) {
      let newDriver = prompt("Enter new driver name:", oldDriver);
      if(newDriver) {
        await updateDoc(doc(db, "logs", id), { driver: newDriver });
        loadReports();
      }
    }

    // WhatsApp Share
    window.shareWhatsApp = function(driver, vehicle, date) {
      let msg = `VK INFRA Report%0ADriver: ${driver}%0AVehicle: ${vehicle}%0ADate: ${date}`;
      window.open(`https://wa.me/?text=${msg}`, "_blank");
    }

    // CSV Export
    window.exportCSV = function() {
      let rows = document.querySelectorAll("#reportTable tr");
      let csv = [];
      rows.forEach(r => {
        let cols = r.querySelectorAll("td,th");
        let arr = [];
        cols.forEach(c => arr.push(c.innerText));
        csv.push(arr.join(","));
      });
      let blob = new Blob([csv.join("\n")], { type:"text/csv" });
      let link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "report.csv";
      link.click();
    }

    // Print Report
    window.printReport = function() {
      let w = window.open("");
      w.document.write(document.getElementById("reportTable").outerHTML);
      w.print();
    }

    // Export PDF
    window.exportPDF = function() { printReport(); }

    // Overall Report
    window.generateOverallReport = async function() {
      let from = document.getElementById("fromDate").value;
      let to = document.getElementById("toDate").value;
      let tbody = document.querySelector("#overallTable tbody");
      tbody.innerHTML = "";

      const snapshot = await getDocs(collection(db, "logs"));
      let summary = {};

      snapshot.forEach(docSnap => {
        let d = docSnap.data();
        if((!from || d.date >= from) && (!to || d.date <= to)) {
          let key = d.driver + "-" + d.vehicleNumber;
          if(!summary[key]) {
            summary[key] = { driver:d.driver, vehicle:d.vehicleType, number:d.vehicleNumber, days:0, hours:0, diesel:0 };
          }
          summary[key].days++;
          summary[key].diesel += Number(d.diesel) || 0;

          function diff(t1,t2){ if(!t1||!t2) return 0; 
            let a=new Date("1970-01-01T"+t1+":00"), b=new Date("1970-01-01T"+t2+":00");
            return (b-a)/3600000; }
          summary[key].hours += diff(d.morningStart,d.morningEnd)+diff(d.afternoonStart,d.afternoonEnd);
        }
      });

      for(let k in summary){
        let s=summary[k];
        tbody.innerHTML += `<tr>
          <td>${s.driver}</td><td>${s.vehicle}</td><td>${s.number}</td>
          <td>${s.days}</td><td>${s.hours.toFixed(2)}</td><td>${s.diesel}</td>
        </tr>`;
      }
      showPage("overallReport");
    }
  </script>

  <script>
    let correctId="VK INFRA", defaultPass="Rajesh@1234";
    if(!localStorage.getItem("password")) localStorage.setItem("password",defaultPass);

    function login(){
      let id=document.getElementById("loginId").value;
      let pass=document.getElementById("loginPass").value;
      if(id===correctId && pass===localStorage.getItem("password")){
        showPage("dashboard");
      } else alert("❌ Invalid ID/Password");
    }
    function logout(){ showPage("loginPage"); }
    function openPage(p){ showPage(p); }
    function backToDashboard(){ showPage("dashboard"); }
    function showPage(p){ document.querySelectorAll(".page").forEach(pg=>pg.classList.remove("active")); document.getElementById(p).classList.add("active"); }

    function changePassword(){
      let old=document.getElementById("oldPass").value;
      let newp=document.getElementById("newPass").value;
      if(old===localStorage.getItem("password") && newp){
        localStorage.setItem("password",newp);
        alert("✅ Password changed!");
        backToDashboard();
      } else alert("❌ Wrong old password or empty new password");
    }
  </script>
</body>
</html>